VISUAL_STUDIO_VERSION= vc9
OPENBUS_HOME= z:\work\openbus\install\tags\OB_v1_05_02_2011_01_07

OPENBUS_INC= $(OPENBUS_HOME)\incpath
OPENBUS_LIB= $(OPENBUS_HOME)\libpath\$(VISUAL_STUDIO_VERSION)

MICO_HOME= $(OPENBUS_HOME)
MICO_BIN= $(MICO_HOME)\bin\$(VISUAL_STUDIO_VERSION)
MICO_INC= $(MICO_HOME)\incpath\mico-2.3.13
MICO_LIB= $(MICO_HOME)\libpath\$(VISUAL_STUDIO_VERSION)\libmico.lib
MICO_PTHREAD_LIB= $(MICO_HOME)\libpath\$(VISUAL_STUDIO_VERSION)\pthreads.lib
PTHREADS_WIN32_INC= $(OPENBUS_HOME)\incpath\pthreadsWin32

INCLUDE= $(INCLUDE).;stubs;$(MICO_INC);$(OPENBUS_INC)\openbus\cpp;$(OPENBUS_INC)\openbus\cpp\stubs\mico;$(OPENBUS_INC)\logger;$(OPENBUS_INC)\scs;$(OPENBUS_INC)\lua5.1.3;$(OPENBUS_INC)\openssl-0.9.9
CFLAGS= /nologo /EHsc

IDLS= ..\idl\hello.idl
STUBS= stubs\hello.cc

SRC= server.cpp \
     client.cpp \
     stubs/hello.cc

OBJ= obj\$(VISUAL_STUDIO_VERSION)\server.obj \
     obj\$(VISUAL_STUDIO_VERSION)\client.obj \
     obj\$(VISUAL_STUDIO_VERSION)\hello.obj

SLIB= lib\$(VISUAL_STUDIO_VERSION)\openbusmico.lib
DLL= lib\$(VISUAL_STUDIO_VERSION)\openbusmico.dll

all: genstubs server.exe client.exe

$(STUBS): $(IDLS)
	-mkdir stubs
	cd stubs
	$(MICO_BIN)\idl --poa ..\..\idl\hello.idl
	cd ..

genstubs: $(STUBS)

$(OBJ): $(SRC)
	-mkdir obj\$(VISUAL_STUDIO_VERSION)
	CL /c /Foobj\$(VISUAL_STUDIO_VERSION)\ $(CFLAGS) $(SRC)

server.exe: $(OBJ)
	-mkdir lib\$(VISUAL_STUDIO_VERSION)
	LINK /nologo -out:server.exe obj\$(VISUAL_STUDIO_VERSION)\server.obj obj\$(VISUAL_STUDIO_VERSION)\hello.obj $(MICO_LIB) $(MICO_PTHREAD_LIB) $(OPENBUS_LIB)\logger.lib $(OPENBUS_LIB)\lua5.1.lib $(OPENBUS_LIB)\libeay32.lib $(OPENBUS_LIB)\scsmico.lib $(OPENBUS_LIB)\openbusmico.lib wsock32.lib

client.exe: $(OBJ)
	-mkdir lib\$(VISUAL_STUDIO_VERSION)
	LINK /nologo -out:client.exe  obj\$(VISUAL_STUDIO_VERSION)\client.obj obj\$(VISUAL_STUDIO_VERSION)\hello.obj $(MICO_LIB) $(MICO_PTHREAD_LIB) $(OPENBUS_LIB)\logger.lib $(OPENBUS_LIB)\lua5.1.lib $(OPENBUS_LIB)\libeay32.lib $(OPENBUS_LIB)\scsmico.lib $(OPENBUS_LIB)\openbusmico.lib wsock32.lib

clean:
	-rmdir /S /Q stubs
	-rmdir /S /Q obj\$(VISUAL_STUDIO_VERSION)
	-del /Q server.exe client.exe
	